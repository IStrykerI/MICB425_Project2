---
title: "Module 3: Project 2 by Team 5"
subtitle: "Charting the distributed nitrogen cycle"
author: 
  - Karl Abuan
  - May Ho
  - Jonah Lin
  - Leilynaz Malekafzali
  - Tiffany Yang
  - Abdur Rahman M. A. Basher
abstract: |
  This is the abstract.
  It consists of two paragraphs.
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \newcommand*{\secref}[1]{Section~\ref{#1}}
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    fig_caption: true
mainfont: Times
fontsize: 11 pt
editor_options:
  chunk_output_type: console
urlcolor: blue
link-citations: yes
bibliography: main.bib
---

```{r global_options, include=FALSE}
knitr::clean_cache(clean = TRUE)
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.align = "center", echo=FALSE, warning=FALSE, include=TRUE, tidy = TRUE, message=FALSE)
```


```{r, eval=FALSE}
## try http:// if https:// URLs are not supported
source("https://bioconductor.org/biocLite.R")  
biocLite("phyloseq")
library("tidyverse")
library("gridExtra")
library("magrittr")
library("ggpubr")
library("cowplot")
```

```{r, include=FALSE}
source("https://bioconductor.org/biocLite.R")  
library("phyloseq")
library("tidyverse")
library("gridExtra")
library("magrittr")
library("ggpubr")
library("knitr")
library("cowplot")

theme_set(theme_bw())
pal = "Set1"
scale_colour_discrete <-  function(palname=pal, ...){
  scale_colour_brewer(palette=palname, ...)
}
scale_fill_discrete <-  function(palname=pal, ...){
  scale_fill_brewer(palette=palname, ...)
}
```

* * *
# Introduction
# Materials and Experimental Configuration
## Experimental Protocols

To understand the correlation of microbial diversity and oxygen concentration across samples, we report four experimentally designed test protocols:

**P1.** Analysis of the DNA abundance of norB with depth.

**P2.** Analysis of similarities between RNA and DNA abundance information of norB with depths.

**P3.** Reconstructing the associated taxa with norB and analyze variances of DNA and RNA based on depths.

**P4.** Analysis of the abundance of norB in relation to nitrogen species in Saanich.


## Dataset

```{r loadingDNA}
## DNA
norB.DNA.10m <- read_tsv("data/dna/norB_DNA_10m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.10 = Confident_Taxonomy, Abund.DNA.10 = Abundance, Query)

norB.DNA.100m <- read_tsv("data/dna/norB_DNA_100m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.100 = Confident_Taxonomy, Abund.DNA.100 = Abundance, Query)

norB.DNA.120m <- read_tsv("data/dna/norB_DNA_120m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.120 = Confident_Taxonomy, Abund.DNA.120 = Abundance, Query)

norB.DNA.135m <- read_tsv("data/dna/norB_DNA_135m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.135 = Confident_Taxonomy, Abund.DNA.135 = Abundance, Query)

norB.DNA.150m <- read_tsv("data/dna/norB_DNA_150m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.150 = Confident_Taxonomy, Abund.DNA.150 = Abundance, Query)

norB.DNA.165m <- read_tsv("data/dna/norB_DNA_165m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.165 = Confident_Taxonomy, Abund.DNA.165 = Abundance, Query)

norB.DNA.200m <- read_tsv("data/dna/norB_DNA_200m_marker_contig_map.tsv") %>% 
  select(Tax.DNA.200 = Confident_Taxonomy, Abund.DNA.200 = Abundance, Query)

## RNA
norB.RNA.10m <- read_tsv("data/rna/norB_RNA_10m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.10 = Confident_Taxonomy, Abund.RNA.10 = Abundance, Query)

norB.RNA.100m <- read_tsv("data/rna/norB_RNA_100m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.100 = Confident_Taxonomy, Abund.RNA.100 = Abundance, Query)

norB.RNA.120m <- read_tsv("data/rna/norB_RNA_120m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.120 = Confident_Taxonomy, Abund.RNA.120 = Abundance, Query)

norB.RNA.135m <- read_tsv("data/rna/norB_RNA_135m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.135 = Confident_Taxonomy, Abund.RNA.135 = Abundance, Query)

norB.RNA.150m <- read_tsv("data/rna/norB_RNA_150m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.150 = Confident_Taxonomy, Abund.RNA.150 = Abundance, Query)

norB.RNA.165m <- read_tsv("data/rna/norB_RNA_165m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.165 = Confident_Taxonomy, Abund.RNA.165 = Abundance, Query)

norB.RNA.200m <- read_tsv("data/rna/norB_RNA_200m_marker_contig_map.tsv") %>% 
  select(Tax.RNA.200 = Confident_Taxonomy, Abund.RNA.200 = Abundance, Query)
```

## Data Preporocessing

Manipulate the data into a single data frame

```{r preprocessing}
norB.all <- norB.DNA.10m %>% 
# Combine the data frames will full_join to keep all the data
  full_join(norB.DNA.100m, by = "Query") %>%
  full_join(norB.DNA.120m, by = "Query") %>% 
  full_join(norB.DNA.135m, by = "Query") %>%
  full_join(norB.DNA.150m, by = "Query") %>% 
  full_join(norB.DNA.165m, by = "Query") %>% 
  full_join(norB.DNA.200m, by = "Query") %>% 
  full_join(norB.RNA.10m, by = "Query") %>%
  full_join(norB.RNA.100m, by = "Query") %>% 
  full_join(norB.RNA.120m, by = "Query") %>% 
  full_join(norB.RNA.135m, by = "Query") %>%
  full_join(norB.RNA.150m, by = "Query") %>% 
  full_join(norB.RNA.165m, by = "Query") %>% 
  full_join(norB.RNA.200m, by = "Query") %>% 
# Create a taxonomy variable aggregating all taxonomy columns so as to fill in any NAs that might occur. !is.na means "is not NA", so the following says that the Taxonomy data should be taken from Tax.RNA.10 if that is not NA, or else take it from Tax.DNA.10 if that is not NA, or else Tax.RNA.200, etc. until if all are NA, give Taxonomy of "unclassified"
  mutate(Taxonomy = ifelse(!is.na(Tax.DNA.10), Tax.DNA.10,
                    ifelse(!is.na(Tax.DNA.100), Tax.DNA.100,
                    ifelse(!is.na(Tax.DNA.120), Tax.DNA.120,
                    ifelse(!is.na(Tax.DNA.135), Tax.DNA.135,
                    ifelse(!is.na(Tax.DNA.150), Tax.DNA.150,
                    ifelse(!is.na(Tax.DNA.165), Tax.DNA.165,
                    ifelse(!is.na(Tax.DNA.200), Tax.DNA.200,
                    ifelse(!is.na(Tax.RNA.10), Tax.RNA.10,
                    ifelse(!is.na(Tax.RNA.100), Tax.RNA.100,
                    ifelse(!is.na(Tax.RNA.120), Tax.RNA.120,
                    ifelse(!is.na(Tax.RNA.135), Tax.RNA.135,
                    ifelse(!is.na(Tax.RNA.150), Tax.RNA.150,
                    ifelse(!is.na(Tax.RNA.165), Tax.RNA.165,
                    ifelse(!is.na(Tax.RNA.200), Tax.RNA.200,
                           "unclassified"))))))))))))))) %>% 
# Get rid of the old Tax variables
  select(-starts_with("Tax.")) %>% 
# Gather all the abundance data into 1 column 
  gather("Key", "Abundance", starts_with("Abund")) %>% 
# Turn the Key into Depth and RNA/DNA variables. We can easily do this because we specifically named these variables with period separation when we loaded in the original data
  separate(Key, c("Key","Type","Depth_m"), by = ".") %>% 
# Remove Key variable now that it only contains "Abund". This also serves to reorder the columns so that the very long Query is at the end.
  select(Depth_m, Type, Abundance, Taxonomy, Query) %>% 
# Make sure R knows depth is numerical since it came from a character variable
  mutate(Depth_m = as.numeric(Depth_m)) %>%
  # Make sure to impute missing abundant information by setting it to 0
  mutate(Abundance = ifelse(is.na(Abundance), 0, Abundance)) %>%
  # Separate Taxonomy into columns so we can plot at different levels
  separate(Taxonomy, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep="; ")
```

```{r normalize}
# Also, normalize abundance information relative based on DNA or RNA 
norB.all.norm <- norB.all %>% 
  group_by(Type) %>%
  mutate(Abundance = ifelse(Abundance==0, 0, Abundance/sum(Abundance))) %>%
  ungroup()
```

# Results

## Analysis of the DNA abundance of norB with depth \label{sec:community}

```{r}
abun.dna.by.depth <- norB.all %>% 
  filter(Type=="DNA") %>%
  group_by(Depth_m) %>%
  summarise(Abundance_DNA=sum(Abundance))

kable(abun.dna.by.depth,caption="Unnormalized abundance of the norB gene (DNA) at different depths")
```

```{r figure1}
plot1 <- norB.all.norm %>% 
  # Filter the DNA data
  filter(Type == "DNA") %>% 
  # Change NAs to "unclassified" at the level you want to plot. Here we will do Genus
  mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 

  ggplot(aes(x = "norB", y = Depth_m)) +
  # Use the size aesthetic to show abundance
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance*100)), colour="brown") +
  # Reverse the why axis so depth increases going down
  scale_y_reverse(lim=c(200,10)) +
  scale_size("Norm. relative abundance (%)") + 
  labs(x = "", y="Depth (m)") +
  theme_classic()

annotate_figure(plot1, bottom = text_grob("Figure 1: Normalized relative abundance (0-1) of the norB gene (DNA) at different depths", size = 12))
```


## Analysis of similarities between RNA and DNA abundance information of norB with depths \label{sec:OTUabundance}

```{r}
abun.rna.by.depth <- norB.all %>% 
  filter(Type=="RNA") %>%
  group_by(Depth_m) %>%
  summarise(Abundance_RNA=sum(Abundance))

abun.by.depth <- full_join(x = abun.dna.by.depth, 
                           y = abun.rna.by.depth, 
                           by = "Depth_m")
kable(abun.by.depth, caption="Unnormalized abundance of the norB gene (DNA vs. RNA) at different depths")
```

```{r figure2}
plot1<- norB.all.norm %>% 
# Change NAs to "unclassified" at the level you want to plot
  mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 
  # Show both RNA and DNA using an x variable  
  ggplot(aes(x = Type, y = Depth_m)) +
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance*100)), colour="brown") +
  scale_y_reverse(lim=c(200, 10)) +
  # Remove zeros by setting min limit to 1e-09
  scale_size("Norm. relative abundance (%)") + 
  labs(x = "", y="Depth (m)") +
  theme_classic()

annotate_figure(plot1, bottom = text_grob("Figure 2: Normalized relative abundance (0-1) of the norB gene (DNA vs. RNA) at different depths", size = 12))
```


## Reconstructing the associated taxa with norB and analyze variances of DNA and RNA based on depths \label{sec:richness}

```{r}
abun.by.phylum <- norB.all %>%
  group_by(Type, Phylum, Genus) %>%
  summarise(Abundance = sum(Abundance)) %>%
  ungroup()

## DNA
abun.dna.by.phylum <- abun.by.phylum %>%
  filter(Type=="DNA")
abun.dna.by.phylum.nonNA <- abun.dna.by.phylum %>%
  filter(!is.na(Genus))

## RNA 
abun.rna.by.phylum <- abun.by.phylum %>%
  filter(Type == "RNA")
abun.rna.by.phylum.nonNA <- abun.rna.by.phylum %>%
  filter(!is.na(Genus))

## Join DNA and RNA
abun.by.phylum <- abun.dna.by.phylum %>% 
  select(Phylum, Genus, Abundance_DNA = Abundance) %>%
  mutate(Abundance_RNA = abun.rna.by.phylum$Abundance)

kable(abun.by.phylum, caption="Taxa associated (including NA values) with unnormalized abundance of the norB gene (DNA vs. RNA) at all depths")
```

The total unnormalized abundances computed from DNA and RNA data is `r sum(abun.dna.by.phylum$Abundance)` and `r sum(abun.rna.by.phylum$Abundance)`, respictavely; however, only `r (sum(abun.dna.by.phylum.nonNA$Abundance))/sum(abun.dna.by.phylum$Abundance) * 100`$\%$ and `r (sum(abun.rna.by.phylum.nonNA$Abundance))/sum(abun.rna.by.phylum$Abundance) * 100`$\%$ have known genera for both DNA and RNA. We impute ``NA`` with ``unclassified`` for phylum and genus. 

<!-- ![Distribution of Species from DNA at 10m depth of Saanich Inlet](final_trees/dna/norB_DNA_10m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 100m depth of Saanich Inlet](final_trees/dna/norB_DNA_100m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 120m depth of Saanich Inlet](final_trees/dna/norB_DNA_120m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 135m depth of Saanich Inlet](final_trees/dna/norB_DNA_135m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 150m depth of Saanich Inlet](final_trees/dna/norB_DNA_150m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 165m depth of Saanich Inlet](final_trees/dna/norB_DNA_165m.pdf){width=60%} -->

<!-- ![Distribution of Species from DNA at 200m depth of Saanich Inlet](final_trees/dna/norB_DNA_200m.pdf){width=60%} -->


```{r figure3}
plot1 <- norB.all.norm %>% 
# Change NAs to "unclassified" at the level you want to plot
  mutate(Phylum = ifelse(is.na(Phylum), "unclassified", Phylum)) %>% 
  
ggplot(aes(x = Phylum, y = Depth_m)) +
# Use an ifelse statement to make 0 values into NAs so that they don't show up on the plot
# Use position_dodge to keep points from overlapping
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance*100), color = Type),
             position = position_dodge(0.5)) +
  scale_y_reverse(lim=c(200,10)) +
  scale_size("Norm. relative abundance (%)") + 
  labs(x = "", y="Depth (m)") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

annotate_figure(plot1, bottom = text_grob("Figure 3: Abundance of Phyla with norB (DNA vs. RNA) at different depths", size = 12))
```


```{r figure4}
plot1 <- norB.all.norm %>% 
# Change NAs to "unclassified" at the level you want to plot
  mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 
  
ggplot(aes(x = Genus, y = Depth_m)) +
# Use an ifelse statement to make 0 values into NAs so that they don't show up on the plot
# Use position_dodge to keep points from overlapping
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance*100), color = Type),
             position = position_dodge(0.5)) +
  scale_y_reverse(lim=c(200,10)) +
  scale_size("Norm. relative abundance (%)") + 
  labs(x = "", y="Depth (m)") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

annotate_figure(plot1, bottom = text_grob("Figure 4: Abundance of genera with norB (DNA vs. RNA) at different depths", size = 12))
```


## Analysis of the abundance of norB in relation to nitrogen species in Saanich \label{sec:ASVabundances}

```{r figure5}
load("data/mothur_phyloseq.RData")
metadata <- data.frame(mothur@sam_data)

plot2 <- metadata %>% 
# Order the data by depth  
  arrange(Depth_m) %>% 
  
ggplot(aes(x = NO3_uM, y = Depth_m)) +
  geom_point(aes(x=NO3_uM, y=Depth_m),size=5, alpha=0.7) +
  geom_path(aes(group = 1)) +
  scale_y_reverse(limits = c(200,10)) +
  labs(y = "Depth (m)", x = "NO3_uM")

plot3 <- metadata %>% 
# Order the data by depth  
  arrange(Depth_m) %>% 
  
ggplot(aes(x = NO2_uM, y = Depth_m)) +
  geom_point(aes(x=NO2_uM, y=Depth_m),size=5, alpha=0.7) +
  geom_path(aes(group = 1)) +
  scale_y_reverse(limits = c(200,10)) +
  labs(y = "Depth (m)", x = "NO2_uM")

plot4 <- metadata %>% 
# Order the data by depth  
  arrange(Depth_m) %>% 
  
ggplot(aes(x = N2O_nM, y = Depth_m)) +
  geom_point(aes(x=N2O_nM, y=Depth_m),size=5, alpha=0.7) +
  geom_path(aes(group = 1)) +
  scale_y_reverse(limits = c(200,10)) +
  labs(y = "Depth (m)", x = "N2O_nM")

annotate_figure(ggarrange(plot2, plot3, plot4, ncol = 3, nrow = 1, 
                                     labels = c("(a)", "(b)", "(c)")),
                bottom = text_grob("Figure 5: Abundance of norB in relation to nitrogen species across depths", size = 12))
```


# Discussion

---

# References
